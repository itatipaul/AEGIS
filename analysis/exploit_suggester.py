import subprocess
import shutil

PRIORITY = 35
TYPE = "Analysis"
DESCRIPTION = "Maps detected service versions to public exploits (via SearchSploit)"

def run(kb):
    print(f"[*] Running {DESCRIPTION}...")
    
    # Check if searchsploit is installed
    if not shutil.which("searchsploit"):
        print("    [-] 'searchsploit' binary not found. Install it via: sudo apt install exploitdb")
        return

    # Gather banners from port scan
    open_ports = kb.get("open_ports", {})
    if not open_ports:
        return

    # Gather tech from tech detect
    tech_stack = kb.get("tech_stack", {})

    # Combine potential search terms
    queries = set()

    # 1. Process Ports/Banners
    for host, ports in open_ports.items():
        for p in ports:
            banner = p.get("banner")
            service = p.get("service")
            
            # Clean banner for searching (e.g., "Apache/2.4.49 (Unix)" -> "Apache 2.4.49")
            if banner and len(banner) > 3:
                # Simple heuristic to strip extra chars
                clean_banner = banner.split('(')[0].split('-')[0].strip()
                queries.add(clean_banner)
            elif service and service != "unknown":
                queries.add(service)

    # 2. Process Tech Stack
    for host, info in tech_stack.items():
        for tech in info.get("technologies", []):
            queries.add(tech)
        if info.get("server"):
            queries.add(info.get("server"))

    if not queries:
        print("    [-] No versions/banners found to query.")
        return

    print(f"    > Querying Exploit-DB for {len(queries)} products...")

    found_exploits = []

    for query in queries:
        # Skip generic terms
        if len(query) < 4 or query.lower() in ["http", "tcp", "unknown"]:
            continue

        try:
            # Run searchsploit
            # --json output would be better but requires newer version, parsing text for compatibility
            cmd = ["searchsploit", "--www", query]
            result = subprocess.run(cmd, capture_output=True, text=True)
            
            output = result.stdout.strip()
            if output and "Exploits: No Results" not in output:
                # Parse top 3 results
                lines = output.split('\n')[3:6] # Skip headers
                for line in lines:
                    if "|" in line:
                        print(f"      [!] EXPLOIT FOUND for '{query}':")
                        print(f"          {line.strip()}")
                        found_exploits.append({"product": query, "exploit": line.strip()})
        except Exception as e:
            pass

    if found_exploits:
        kb.update("suggested_exploits", found_exploits)
        
        # Save to loot
        with open("loot/suggested_exploits.txt", "w") as f:
            for item in found_exploits:
                f.write(f"Target: {item['product']}\nExploit: {item['exploit']}\n{'-'*40}\n")
